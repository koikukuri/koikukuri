// --- 設定 ---
const LIFF_ID = "2007667389-LBMOpGMy"; // LIFF IDを修正済み
const GAS_WEB_APP_URL = "https://script.google.com/a/macros/coconazo.com/s/AKfycbyTjlNyHz5xGe-1XrBzzn5-DF8haB3WUw5ISqfqtcs7p4HRLmrV4oVZ-3PmfBvjkFwAPQ/exec";

// --- 要素の取得 ---
const loadingScreen = document.getElementById('loading-screen');
const mainScreen = document.getElementById('main-screen');
const messageModal = document.getElementById('message-modal');
let myUserId = '';

// --- メイン処理 ---
async function main() {
    try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) {
            liff.login(); // ログインしていない場合はログイン画面へ
            return;
        }
        const profile = await liff.getProfile();
        myUserId = profile.userId;
        await showMainScreen(); // メイン画面の表示処理へ
    } catch (error) {
        console.error(error);
        // LIFF初期化失敗時のメッセージを改善
        loadingScreen.innerHTML = `<p class="text-red-600 font-bold">LIFFの初期化に失敗しました。</p><p class="text-sm mt-2">LIFF IDまたはエンドポイントURLの設定が間違っている可能性があります。管理者にご確認ください。</p><p class="text-xs mt-4 text-gray-500">エラー詳細: ${error.message}</p>`;
    }
}

// --- 画面表示ロジック ---
async function showMainScreen() {
    try {
        loadingScreen.style.display = 'flex'; // ローディング画面を表示
        
        // GAS Web Appから参加者データを取得（ユーザーIDをURLパラメータに追加）
        const response = await fetch(GAS_WEB_APP_URL + `?action=getParticipants&userId=${myUserId}`);
        const data = await response.json();

        // GASからのエラー応答をチェック
        if (data.status === 'error') {
            throw new Error(data.message || '不明なエラーが発生しました。');
        }

        const allParticipants = data;

        // 取得したデータが配列形式か確認
        if (!Array.isArray(allParticipants)) {
            throw new Error("参加者データの形式が正しくありません。");
        }

        // 現在のユーザーが参加者リストにいるか確認
        const myProfile = allParticipants.find(p => p.userId === myUserId);
        if (!myProfile) {
            // **ここが修正点！参加者でない場合のメッセージ表示**
            loadingScreen.innerHTML = `<p class="text-red-600 font-bold">現在、イベント参加者のみ表示いただけます。</p><p class="text-sm mt-2">このアプリはイベント参加中の方のみがご利用可能です。ご不明な点があれば、管理者にお問い合わせください。</p>`;
            return; // 参加者でない場合はここで処理を終了
        }
        
        // 異性の参加者リストをフィルタリング
        const oppositeGender = myProfile.gender === '男性' ? '女性' : '男性';
        const oppositeGenderParticipants = allParticipants.filter(p => p.gender === oppositeGender);

        // UIの更新
        document.getElementById('opposite-gender-title').textContent = `${oppositeGender}メンバー`;
        document.getElementById('opposite-gender-title').classList.add(oppositeGender === '男性' ? 'text-blue-500' : 'text-pink-500');

        const listElement = document.getElementById('opposite-gender-list');
        listElement.innerHTML = ''; // リストをクリア
        oppositeGenderParticipants.forEach(p => listElement.appendChild(createParticipantCard(p)));

        loadingScreen.style.display = 'none'; // ローディング画面を非表示
        mainScreen.style.display = 'block'; // メイン画面を表示
    } catch (error) {
        console.error(error);
        // 参加者情報取得失敗時のメッセージを改善
        loadingScreen.innerHTML = `<p class="text-red-500 font-bold">情報の読み込み中にエラーが発生しました。</p><p class="text-sm mt-2">${error.message}</p><p class="text-xs mt-4 text-gray-500">問題が解決しない場合は、管理者にご連絡ください。</p>`;
    }
}
    
function createParticipantCard(p) {
    const template = document.getElementById('participant-card-template');
    const card = template.content.cloneNode(true); // テンプレートを複製
    
    // プロフィール情報を設定
    card.querySelector('.profile-name').textContent = p.nickname || '名前未設定';
    
    const subInfoParts = [];
    if (p.age) subInfoParts.push(`${p.age}歳`);
    if (p.occupation) subInfoParts.push(p.occupation);
    card.querySelector('.profile-sub-info').textContent = subInfoParts.join(' / ');
    
    const hobbyWrapper = card.querySelector('.profile-hobby-wrapper');
    if (p.hobby) {
        hobbyWrapper.querySelector('.profile-hobby').textContent = p.hobby;
        hobbyWrapper.style.display = 'block';
    }

    const commentWrapper = card.querySelector('.profile-comment-wrapper');
    if (p.comment) {
        commentWrapper.querySelector('.profile-comment').textContent = p.comment;
        commentWrapper.style.display = 'block';
    }
    
    // いいねボタンのイベントリスナー
    card.querySelector('.like-btn').addEventListener('click', (e) => {
        e.currentTarget.classList.add('liked'); // いいね済みクラスを追加
        sendAction('like', p.userId); // GASにアクションを送信
    });
    
    // メッセージボタンのイベントリスナー
    card.querySelector('.message-btn').addEventListener('click', () => {
        openMessageModal(p.userId, p.nickname); // メッセージモーダルを開く
    });
    
    return card;
}

// --- イベントハンドラ ---
document.getElementById('modal-close-btn').addEventListener('click', () => messageModal.style.display = 'none'); // モーダルを閉じる

// --- モーダル処理 ---
function openMessageModal(targetUserId, targetUserName) {
    const modalTitle = document.getElementById('modal-title');
    const messageButtons = document.getElementById('message-buttons');
    modalTitle.textContent = `${targetUserName}さんにメッセージ`; // モーダルタイトルを設定
    messageButtons.innerHTML = ''; // ボタンリストをクリア

    const messages = [
        { text: 'おめでとう！🎉', type: 'personal' },
        { text: 'ありがとう！😊', type: 'personal' },
        { text: 'すごい！✨', type: 'personal' },
        { text: 'お話ししたいです！☕', type: 'personal' },
        { text: 'たのしかった！😆', type: 'personal' },
        { text: 'ごめんなさい🙏', type: 'personal' },
        { text: 'たすけて！🆘', type: 'personal' },
        { text: 'たすけて！🆘', type: 'all' } // 全員に送るメッセージ例
    ];

    messages.forEach(msg => {
        const btn = document.createElement('button');
        btn.className = "w-full bg-pink-100 hover:bg-pink-200 text-pink-800 font-bold py-3 px-4 rounded-lg";
        
        let btnText = msg.text;
        if (msg.type === 'all') {
            btnText = `<i class="fas fa-bullhorn mr-2"></i> ${msg.text} (全員に)`;
            // 全員へのメッセージボタンは色を変える
            btn.classList.remove('bg-pink-100', 'hover:bg-pink-200', 'text-pink-800');
            btn.classList.add('bg-amber-400', 'hover:bg-amber-500', 'text-white');
        }
        btn.innerHTML = btnText;

        btn.onclick = () => {
            const confirmMessage = msg.type === 'all' 
                ? `全員に「${msg.text}」と通知します。よろしいですか？`
                : `「${msg.text}」を送信します。よろしいですか？`;

            if (confirm(confirmMessage)) {
                sendAction('sendMessage', targetUserId, { message: msg.text, type: msg.type }); // メッセージを送信
                messageModal.style.display = 'none'; // モーダルを閉じる
                alert(`「${msg.text}」を送信しました！`); // 送信完了を通知
            }
        };
        messageButtons.appendChild(btn);
    });
    messageModal.style.display = 'flex'; // モーダルを表示
}

// --- データ送信 ---
async function sendData(data) {
    try {
        await fetch(GAS_WEB_APP_URL, {
            method: 'POST', mode: 'no-cors', // POSTリクエストでデータを送信
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams(data)
        });
    } catch (error) {
        console.error('データ送信に失敗:', error);
    }
}
    
async function sendAction(action, targetUserId, details = {}) {
    await sendData({ action, fromUserId: myUserId, targetUserId, ...details }); // 特定のアクションを送信
}

// --- 初期化 ---
main(); // アプリ起動時にメイン処理を実行
