// --- è¨­å®š ---
const LIFF_ID = "2007667389-LBMOpGMy"; // LIFF IDã‚’ä¿®æ­£æ¸ˆã¿
const GAS_WEB_APP_URL = "https://script.google.com/a/macros/coconazo.com/s/AKfycbyTjlNyHz5xGe-1XrBzzn5-DF8haB3WUw5ISqfqtcs7p4HRLmrV4oVZ-3PmfBvjkFwAPQ/exec";

// --- è¦ç´ ã®å–å¾— ---
const loadingScreen = document.getElementById('loading-screen');
const mainScreen = document.getElementById('main-screen');
const messageModal = document.getElementById('message-modal');
let myUserId = '';

// --- ãƒ¡ã‚¤ãƒ³å‡¦ç† ---
async function main() {
    try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) {
            liff.login(); // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆã¯ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸
            return;
        }
        const profile = await liff.getProfile();
        myUserId = profile.userId;
        await showMainScreen(); // ãƒ¡ã‚¤ãƒ³ç”»é¢ã®è¡¨ç¤ºå‡¦ç†ã¸
    } catch (error) {
        console.error(error);
        // LIFFåˆæœŸåŒ–å¤±æ•—æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ”¹å–„
        loadingScreen.innerHTML = `<p class="text-red-600 font-bold">LIFFã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p><p class="text-sm mt-2">LIFF IDã¾ãŸã¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆURLã®è¨­å®šãŒé–“é•ã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ç®¡ç†è€…ã«ã”ç¢ºèªãã ã•ã„ã€‚</p><p class="text-xs mt-4 text-gray-500">ã‚¨ãƒ©ãƒ¼è©³ç´°: ${error.message}</p>`;
    }
}

// --- ç”»é¢è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ ---
async function showMainScreen() {
    try {
        loadingScreen.style.display = 'flex'; // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’è¡¨ç¤º
        
        // GAS Web Appã‹ã‚‰å‚åŠ è€…ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«è¿½åŠ ï¼‰
        const response = await fetch(GAS_WEB_APP_URL + `?action=getParticipants&userId=${myUserId}`);
        const data = await response.json();

        // GASã‹ã‚‰ã®ã‚¨ãƒ©ãƒ¼å¿œç­”ã‚’ãƒã‚§ãƒƒã‚¯
        if (data.status === 'error') {
            throw new Error(data.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
        }

        const allParticipants = data;

        // å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ãŒé…åˆ—å½¢å¼ã‹ç¢ºèª
        if (!Array.isArray(allParticipants)) {
            throw new Error("å‚åŠ è€…ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚");
        }

        // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‚åŠ è€…ãƒªã‚¹ãƒˆã«ã„ã‚‹ã‹ç¢ºèª
        const myProfile = allParticipants.find(p => p.userId === myUserId);
        if (!myProfile) {
            // **ã“ã“ãŒä¿®æ­£ç‚¹ï¼å‚åŠ è€…ã§ãªã„å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º**
            loadingScreen.innerHTML = `<p class="text-red-600 font-bold">ç¾åœ¨ã€ã‚¤ãƒ™ãƒ³ãƒˆå‚åŠ è€…ã®ã¿è¡¨ç¤ºã„ãŸã ã‘ã¾ã™ã€‚</p><p class="text-sm mt-2">ã“ã®ã‚¢ãƒ—ãƒªã¯ã‚¤ãƒ™ãƒ³ãƒˆå‚åŠ ä¸­ã®æ–¹ã®ã¿ãŒã”åˆ©ç”¨å¯èƒ½ã§ã™ã€‚ã”ä¸æ˜ãªç‚¹ãŒã‚ã‚Œã°ã€ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚</p>`;
            return; // å‚åŠ è€…ã§ãªã„å ´åˆã¯ã“ã“ã§å‡¦ç†ã‚’çµ‚äº†
        }
        
        // ç•°æ€§ã®å‚åŠ è€…ãƒªã‚¹ãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        const oppositeGender = myProfile.gender === 'ç”·æ€§' ? 'å¥³æ€§' : 'ç”·æ€§';
        const oppositeGenderParticipants = allParticipants.filter(p => p.gender === oppositeGender);

        // UIã®æ›´æ–°
        document.getElementById('opposite-gender-title').textContent = `${oppositeGender}ãƒ¡ãƒ³ãƒãƒ¼`;
        document.getElementById('opposite-gender-title').classList.add(oppositeGender === 'ç”·æ€§' ? 'text-blue-500' : 'text-pink-500');

        const listElement = document.getElementById('opposite-gender-list');
        listElement.innerHTML = ''; // ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
        oppositeGenderParticipants.forEach(p => listElement.appendChild(createParticipantCard(p)));

        loadingScreen.style.display = 'none'; // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’éè¡¨ç¤º
        mainScreen.style.display = 'block'; // ãƒ¡ã‚¤ãƒ³ç”»é¢ã‚’è¡¨ç¤º
    } catch (error) {
        console.error(error);
        // å‚åŠ è€…æƒ…å ±å–å¾—å¤±æ•—æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ”¹å–„
        loadingScreen.innerHTML = `<p class="text-red-500 font-bold">æƒ…å ±ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p><p class="text-sm mt-2">${error.message}</p><p class="text-xs mt-4 text-gray-500">å•é¡ŒãŒè§£æ±ºã—ãªã„å ´åˆã¯ã€ç®¡ç†è€…ã«ã”é€£çµ¡ãã ã•ã„ã€‚</p>`;
    }
}
    
function createParticipantCard(p) {
    const template = document.getElementById('participant-card-template');
    const card = template.content.cloneNode(true); // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¤‡è£½
    
    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’è¨­å®š
    card.querySelector('.profile-name').textContent = p.nickname || 'åå‰æœªè¨­å®š';
    
    const subInfoParts = [];
    if (p.age) subInfoParts.push(`${p.age}æ­³`);
    if (p.occupation) subInfoParts.push(p.occupation);
    card.querySelector('.profile-sub-info').textContent = subInfoParts.join(' / ');
    
    const hobbyWrapper = card.querySelector('.profile-hobby-wrapper');
    if (p.hobby) {
        hobbyWrapper.querySelector('.profile-hobby').textContent = p.hobby;
        hobbyWrapper.style.display = 'block';
    }

    const commentWrapper = card.querySelector('.profile-comment-wrapper');
    if (p.comment) {
        commentWrapper.querySelector('.profile-comment').textContent = p.comment;
        commentWrapper.style.display = 'block';
    }
    
    // ã„ã„ã­ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    card.querySelector('.like-btn').addEventListener('click', (e) => {
        e.currentTarget.classList.add('liked'); // ã„ã„ã­æ¸ˆã¿ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
        sendAction('like', p.userId); // GASã«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’é€ä¿¡
    });
    
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    card.querySelector('.message-btn').addEventListener('click', () => {
        openMessageModal(p.userId, p.nickname); // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    });
    
    return card;
}

// --- ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ© ---
document.getElementById('modal-close-btn').addEventListener('click', () => messageModal.style.display = 'none'); // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹

// --- ãƒ¢ãƒ¼ãƒ€ãƒ«å‡¦ç† ---
function openMessageModal(targetUserId, targetUserName) {
    const modalTitle = document.getElementById('modal-title');
    const messageButtons = document.getElementById('message-buttons');
    modalTitle.textContent = `${targetUserName}ã•ã‚“ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸`; // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¨­å®š
    messageButtons.innerHTML = ''; // ãƒœã‚¿ãƒ³ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢

    const messages = [
        { text: 'ãŠã‚ã§ã¨ã†ï¼ğŸ‰', type: 'personal' },
        { text: 'ã‚ã‚ŠãŒã¨ã†ï¼ğŸ˜Š', type: 'personal' },
        { text: 'ã™ã”ã„ï¼âœ¨', type: 'personal' },
        { text: 'ãŠè©±ã—ã—ãŸã„ã§ã™ï¼â˜•', type: 'personal' },
        { text: 'ãŸã®ã—ã‹ã£ãŸï¼ğŸ˜†', type: 'personal' },
        { text: 'ã”ã‚ã‚“ãªã•ã„ğŸ™', type: 'personal' },
        { text: 'ãŸã™ã‘ã¦ï¼ğŸ†˜', type: 'personal' },
        { text: 'ãŸã™ã‘ã¦ï¼ğŸ†˜', type: 'all' } // å…¨å“¡ã«é€ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¾‹
    ];

    messages.forEach(msg => {
        const btn = document.createElement('button');
        btn.className = "w-full bg-pink-100 hover:bg-pink-200 text-pink-800 font-bold py-3 px-4 rounded-lg";
        
        let btnText = msg.text;
        if (msg.type === 'all') {
            btnText = `<i class="fas fa-bullhorn mr-2"></i> ${msg.text} (å…¨å“¡ã«)`;
            // å…¨å“¡ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœã‚¿ãƒ³ã¯è‰²ã‚’å¤‰ãˆã‚‹
            btn.classList.remove('bg-pink-100', 'hover:bg-pink-200', 'text-pink-800');
            btn.classList.add('bg-amber-400', 'hover:bg-amber-500', 'text-white');
        }
        btn.innerHTML = btnText;

        btn.onclick = () => {
            const confirmMessage = msg.type === 'all' 
                ? `å…¨å“¡ã«ã€Œ${msg.text}ã€ã¨é€šçŸ¥ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`
                : `ã€Œ${msg.text}ã€ã‚’é€ä¿¡ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`;

            if (confirm(confirmMessage)) {
                sendAction('sendMessage', targetUserId, { message: msg.text, type: msg.type }); // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
                messageModal.style.display = 'none'; // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                alert(`ã€Œ${msg.text}ã€ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼`); // é€ä¿¡å®Œäº†ã‚’é€šçŸ¥
            }
        };
        messageButtons.appendChild(btn);
    });
    messageModal.style.display = 'flex'; // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
}

// --- ãƒ‡ãƒ¼ã‚¿é€ä¿¡ ---
async function sendData(data) {
    try {
        await fetch(GAS_WEB_APP_URL, {
            method: 'POST', mode: 'no-cors', // POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams(data)
        });
    } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã«å¤±æ•—:', error);
    }
}
    
async function sendAction(action, targetUserId, details = {}) {
    await sendData({ action, fromUserId: myUserId, targetUserId, ...details }); // ç‰¹å®šã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’é€ä¿¡
}

// --- åˆæœŸåŒ– ---
main(); // ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«ãƒ¡ã‚¤ãƒ³å‡¦ç†ã‚’å®Ÿè¡Œ
